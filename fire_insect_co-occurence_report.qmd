---
title: "fire_insect_co-occurrence_report"
format: html
editor: visual
tbl-cap-location: top
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r intialize packages, echo=FALSE}
#| echo: false
#| message: false
#| warning: false

library(tidyverse)
library(DAPSm)
library(ggplot2)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(viridis)
library(cowplot)
library(MatchIt)
source("src/find_best_model.R")




```

```{r required data, echo=FALSE}

#| echo: false
#| message: false
#| warning: false


### prep data
# read in
history = read.csv("/home/goldma34/fire_insect_co-occurence/data/outputs/on/on_defoliation_history_wx.csv")

history <- history %>% 
  rename("host_pct" = "host_percentage")

# read in centroids
centroids <- read.csv("/home/goldma34/fire_insect_co-occurence/data/outputs/on/on_fire_centroids.csv")


# read in recovery
recovery_defol = read.csv("/home/goldma34/fire_insect_co-occurence/data/outputs/on/on_recovery_magnitude/on_recovery_magnitude.csv")

recovery_non_defol = read.csv("/home/goldma34/fire_insect_co-occurence/data/outputs/no_history/on_no_history_recovery_magnitude.csv")

# read in climate post
post_climate_no_history <-  read.csv("/home/goldma34/fire_insect_co-occurence/data/outputs/no_history/on_no_history_final_era5_clim.csv")

post_climate_history_1 <-  read.csv("/home/goldma34/fire_insect_co-occurence/data/outputs/on/on_history_final_era5_clim.csv")

post_climate_history_2 <-  read.csv("/home/goldma34/fire_insect_co-occurence/data/outputs/on/on_history_final_era5_clim_missing.csv")

# merge recovery dataframes
recovery <- rbind(recovery_defol, recovery_non_defol) %>% 
  select(-c("X")) %>% 
  rename(recovery = Average.Recovery)

# merge post climate dataframes
post_climate_history <-  rbind(post_climate_history_1, post_climate_history_2)

# merge post climate dataframes
post_climate <-  rbind(post_climate_history, post_climate_no_history) 

# join recovery to history
history <- history %>% 
  left_join(recovery, by = "Fire_ID")

# join climate to history

history <- history %>% 
  left_join(post_climate, by = 'Fire_ID')

# join fire centroids to history
history <- history %>% 
  left_join(centroids, by = "Fire_ID")


history_gt90 <- history %>% 
  filter(!(Max_Overlap_Percent <= 90 & history ==1 ))

#
h90.sf <- st_as_sf(history_gt90, coords = c("x", "y"), crs = 4326)

#sbw history
sbw <- read.csv("/home/goldma34/fire_insect_co-occurence/data/sbw-defol-data-v2.csv")

# clean history
history_gt90 <- history_gt90 %>% 
  left_join(sbw, by = "Fire_ID") %>% 
  select(-c(Time_Since_Defoliation, Cumulative_Years, defol)) %>% 
  rename(Time_Since_Defol = tsd) %>% 
  rename(Cumulative_Years_Defol = years_defol)

# set windows of opp
history_gt90 <- history_gt90 %>% 
  mutate(window_opp = case_when(Time_Since_Defol >=1 & 
                                  Time_Since_Defol <= 2 & history ==1 ~ "1",
                                Time_Since_Defol >=3 & Time_Since_Defol<= 9 ~"2",
                                Time_Since_Defol >= 10 ~ "3",
                                
                                TRUE ~ "0"))


#Splitting the data for subclass
# keep non-defoliated options
hist_gt90_1 <- subset(history_gt90, window_opp == "0" | window_opp == "1")
hist_gt90_2  <- subset(history_gt90, window_opp == "0" | window_opp == "2")
hist_gt90_3 <- subset(history_gt90, window_opp == "0" | window_opp == "3")




```

```{r, model severity, results='hide'}

#| warning: false
#| message: false
#| echo: false



# Full matching on a probit PS
m.out2 <- matchit(history ~  host_pct +isi_90 + dc_90+ dmc_90 + ffmc_90 + bui_90 + fwi_90,
                  data = history_gt90,
                  method = "nearest",
                  distance = "glm",
                  link = "probit",
                  m.order = "random",
                 ### set a maximum distance for the matches
                 caliper = 0.10)



m.data <- match_data(m.out2)


m.data %>% 
  group_by(history) %>% 
  summarise("Number of Fires" = n()) %>% 
  mutate(history = case_when(history ==1 ~ "Defoliated",
                           history ==0 ~"Non-Defoliated"))

# Convert the data frame to an sf object
m.data.sf <- st_as_sf(m.data, coords = c("x", "y"), crs = 4326)
```

```{r mod-recovery, results='hide'}

#| warning: false
#| message: false
#| echo: false



# Full matching on a probit PS
m.out.rec <- matchit(history ~  host_pct + rbr_w_offset + mean_temperature + sum_precipitation_mm,
                  data = history_gt90,
                  method = "nearest",
                  distance = "glm",
                  link = "probit",
                  m.order = "random",
                 ### set a maximum distance for the matches
                 caliper = 0.10)



m.data.rec <- match_data(m.out.rec)


m.data.rec %>% 
  group_by(history) %>% 
  summarise("Number of Fires" = n()) %>% 
  mutate(history = case_when(history ==1 ~ "Defoliated",
                           history ==0 ~"Non-Defoliated"))

# Convert the data frame to an sf object
m.data.rec.sf <- st_as_sf(m.data.rec, coords = c("x", "y"), crs = 4326)
```

# Overview

## Background

Insect defoliation is the most widespread natural disturbance agent in the eastern boreal forest, affecting more forest area than any other disturbance (McCullough et al 1998, Volney and Fleming 2000). The eastern spruce budworm (Choristoneura fumiferana Clemens) causes the most extensive damage among insect defoliators due to the large scale and high severity of its outbreaks (Navarro et al 2018). Native to North American coniferous forests, the primary hosts of the eastern spruce budworm (SBW) are balsam fir (Abies balsamea), which spruce (Picea glauca), and increasingly black spruce (Picea mariana) due to climate warming-induced phenological synchrony (Pureswaran et al 2019).

SBW defoliation can lead to mortality if it continues for three or more consecutive years. However, more commonly, it results in crown and branch mortality and reduced growth in balsam fir and secondary hosts (MacLean 1984, Bergeron et al 1995, Nealis and Régnière 2004, Bouchard et al 2005). The long-term effects of SBW defoliation on vegetation dynamics are exacerbated by climate warming (Subedi et al 2023). The spatial legacies of SBW outbreaks can create landscape heterogeneity in vegetation patterns that can persist for decades, influencing the likelihood and severity of future disturbances (Taylor and MacLean 2009, James et al 2017).

In 2023, Canada experienced its most severe wildfire season on record, with 18.6 million hectares of forest burned. This, coupled with projected increases in the frequency and severity of outbreaks due to climate warming (Régnière et al 2012, Bouchard et al 2018, Weed et al 2013), raises concerns about the influence of the large-scale spatial legacies of outbreaks on wildfire impacts (Stocks 1987, Candau et al 2018, Fettig et al 2022). Adding to this concern is the climate-induced transition of black spruce from non-host to host species (Pureswaran et al 2019). Black spruce is the most widespread conifer in the eastern boreal forest. They are also considered to be the most flammable due to their resinous needles and their dense, low-lying branches that can easily catch fire and promote vertical spread of ground fires to high-severity canopy fires (Barrett et al 2010, Massey et al 2023).

Wildfire burn severity is a measure of biomass and soil change used to gauge how intensely an ecosystem was impact by fire (Lentile et al 2013). Burn severity is crucial to the structure and function of post-fire boreal ecosystems, influencing post-fire seed sources, aerial bud banks, soil nutrient availability and forest substraties (Splawinski et al. 2019, Brown and Johnstone 2012, Arseneault 2001), which limits post-fire tree establishment and growth (Johnstone and Chapin 2006, Johnstone and Kasischke 2005). Consequently, post-fire recovery trajectories are closely linked to the degree of burn severity (Whitman et al. 2018a, Strand et al. 2019, Lentile et al. 2007).

A number of studies have posited that that spatial legacies of SBW defoliation will influence wildfire impacts on forest ecosystems (Cohn et al 2014; James et al. 2017). While there is evidence that supports insect-induced changes in vegetation structure prior to wildfire (Watt et al 2018, 2020), the causality between these changes and wildfire impacts such as changes in severity remain uncertain. This is because in order to elucidate the potential causal impact of spruce budworm legacies on fire severity requires a control observation for comparison. However, most studies rely on both historical defoliation and observational wildfire data. Identifying a control group is difficult as factors that influence fire outcomes include slope, vegetation type, or vegetation moisture. Therefore, establishing a control observation requires identifying statistically similar controls that burned under similar conditions. Fortunately, pre-processing methods such as propensity score matching are an established method for identifying such quasi-experimental controls in wildfire studies (Bustic, Woo x2 etc). Using pre-processed datasets, analysis such as linear regression can be used to predict average defoliation effect on wildfire severity.

In observational studies, propensity score matching (PSM) is a common statistical technique applied to create a control group that is comparable in confounding variables to a treatment group in studies where treatments are unable to be randomly assigned. For each observation a propensity score (PS) is calculated which reflects the probability of receiving the treatment based on observed characteristics (i.e., potential confounders). Using propensity scores researchers can match participants from the treatment group with those from the control group based on the similarity between scores. The degree of similarity can be selected by researchers. Referred to as the caliper, it is suggested that the degree of similar is within +/- 0.3. By simulating the conditions of a randomized controlled trial, the process of PSM helps to balance the groups on observed characteristics, thereby reducing bias and allowing for a more accurate estimate of the treatment's impact. Using the balanced dataset, researchers are able to provide a more robust and reliable estimate of the treatment's effect.

In this study, we aim to reduce the uncertainty surrounding the causal impacts of spatial legacies of SBW defoliation on wildfire severity in Ontario's boreal shield. We applied PSM to create a balanced control-treatment experimental design with observation data on wildfire-defoliation co-occurrences. We identified wildfires-defoliation co-occurrences between 1985-2012 using aerial-survey defoliation data and remotely sensed wildfire data. For each area, we quantified median burn severity and mean recovery magnitude. Spectral recovery trajectories were used to estimate post-fire recovery, as recent research shows they are effective and accurate at capturing post-fire structural recovery patterns in North American boreal forests (Smith‐Tripp et al 2024). Using these data, we estimated the average treatment effect (ATT) of defoliation on wildfire impacts and long-term outcomes.

## Question

How does the spatial legacies of defoliated areas affect **(a) burn severity** and **(b) recovery magnitude?**

Are there hotspots where defoliation has a more pronounced effect?

-   Are there other factors that interact with defoliation to influence spatial patterns of burn severity and recovery magnitude in defoliated areas?

## Methods

### Study area

We focused our analysis on the boreal shield ecozone of Ontario (65,336,847 ha) @fig-study-area-2. There is a climatic gradient across this region, with colder and drier conditions in the west and more precipitation to the east (Girardin and Mudelsee 2008). The area is predominantly covered by black spruce (picea mariana) and balsam fir (abies balsamea).

Spruce budworm outbreaks have frequently erupted across Ontario's boreal shield ecoregion over the past few decades. A severe outbreak occured from 1968 to 1988 where insect activity peaked around 1980. This outbreak was followed by a second, moderate severity outbreak that erupted in 2000s that continued well into into the 2010s (Navarro et al 2018, Berguet et al 2021).

```{r  warning=FALSE, message=FALSE, echo=FALSE}

#| label:study-area-code
#| warning: false
#| message: false
#| echo: false

# Load Ontario map data
ontario <- ne_states(country = "Canada", returnclass = "sf") %>%
  filter(name == "Ontario")


# Create the inset pie chart for m.data.sf
inset_data1 <- h90.sf %>%
  group_by(history) %>%
  summarise(count = n())

inset_pie1 <- ggplot(inset_data1, aes(x = "", y = count, fill = factor(history))) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar("y") +
  scale_fill_manual(values = c("0" = "#FF8C00A0", "1" = "#8B0000A0"), 
                    name = NULL, 
                    labels = c("0" = "Non-Defoliated", "1" = "Defoliated")) +
  theme_void() +
  labs(x = NULL, y = NULL) +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank(),
        legend.position = "none") +
  geom_text(aes(label = count), position = position_stack(vjust = 0.5), size = 3)  # Adjust the size here

# Create the inset pie chart for m.data.sf2
inset_data2 <- m.data.sf %>%
  group_by(history) %>%
  summarise(count = n())

inset_pie2 <- ggplot(inset_data2, aes(x = "", y = count, fill = factor(history))) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar("y") +
  scale_fill_manual(values = c("0" = "#FF8C00A0", "1" = "#8B0000A0"), 
                    name = NULL, 
                    labels = c("0" = "Non-Defoliated", "1" = "Defoliated")) +
  theme_void() +
  labs(x = NULL, y = NULL) +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank(),
        legend.position = "none") +
  geom_text(aes(label = count), position = position_stack(vjust = 0.5), size = 3)  # Adjust the size here
# Create the first map with inset
map1 <- ggplot() +
  geom_sf(data = ontario, fill = "navajowhite1", color = "black") +
  geom_sf(data = h90.sf, aes(color = factor(history)), size = 1) +
  scale_color_manual(values = c("0" = "#FF8C00A0", "1" = "#8B0000A0"), 
                     name = NULL, 
                     labels = c("0" = "Non-Defoliated", "1" = "Defoliated"),
                     guide = guide_legend(title.position = "top", title.hjust = 0.4)) +
  theme_void() +
  theme(
    plot.title = element_text(hjust = 0, size = 16),
    legend.position = "right",
    legend.direction = "horizontal",
    legend.text = element_text(size = 10)
  ) +
  labs(title = "A)") +
  annotation_custom(ggplotGrob(inset_pie1), xmin = -78, xmax = -73, ymin = 42, ymax = 52)

# Create the second map with inset using m.data.sf2
map2 <- ggplot() +
  geom_sf(data = ontario, fill = "navajowhite1", color = "black") +
  geom_sf(data = m.data.sf, aes(color = factor(history)), size = 1) +
  scale_color_manual(values = c("0" = "#FF8C00A0", "1" = "#8B0000A0"), 
                     name = NULL, 
                     labels = c("0" = "Non-Defoliated", "1" = "Defoliated"),
                     guide = guide_legend(title.position = "top", title.hjust = 0.4)) +
  theme_void() +
  theme(
    plot.title = element_text(hjust = 0, size = 16),
    legend.position = "top",
    legend.direction = "horizontal",
    legend.text = element_text(size = 10)
  ) +
  labs(title = "B)") +
  annotation_custom(ggplotGrob(inset_pie2), xmin = -78, xmax = -73, ymin = 42, ymax = 52)



# Extract the legend from one of the maps
legend <- cowplot::get_legend(map1)

# Combine the legend and the two maps
combined_plot <- plot_grid(
  legend,
  plot_grid(
    map1 + theme(legend.position = "none"),
    map2 + theme(legend.position = "none"),
    ncol = 2,
    rel_widths = c(1, 1)
  ),
  ncol = 1,
  rel_heights = c(0.1, 1)
)


```

```{r}
#| fig-cap: Study area fires
#| label: fig-study-area-2
#| echo: false

combined_plot

```

### Fire data

We obtained wildfire occurrence and polygon data for the years 1986 to 2012 from the National Burned Area Composite for the boreal shield ecozone of Ontario (Skakun et al 2022). We excluded all fires that were classified as prescribed burns and removed those categorized as reburns -- fires that burned through a previously burnt area - following an existing protocol (Whitman et al 2020). Reburns can exhibit significant variation in burn severity relative to areas without recent history of wildfire (Whitman et al 2019). Fires were removed if the overlap between polygons was greater than the smallest area burned in our dataset (40ha) or if the gap between the fires was equal to or less than 26 years. The 26-year threshold represents the earliest year for which we had fire perimeter data for the first fire in our dataset.

### Spruce budworm data

We obtained defoliation polygons from publicly available forest insect damage events maps produced and distributed by Ontario for the years 1975 to 2012. We filtered each dataset to include only spruce budworm polygons. Each dataset attributed a single defoliation event to an individual polygon, with multiple, independent polygons recorded per year. For each province, we consolidated the data by year into a multipolygon dataset, where each row represented all defoliation events that occurred in a single year from 1975 to 2012. This allowed us to count the number of years a specific area had been defoliated by assessing the overlap of polygons across different years.

### Fire selection

We identified wildfire-insect co-occurrences by identifying fires that burned in defoliated areas. For each fire, we calculated the intersection between the fire polygon and any defoliated polygon for 15 years prior to the year of the fire event. We restricted the time between defoliation events and wildfire occurrence were 15 years because previous evidence suggests that the spatial legacies of defoliation have a negligible impact on wildfire behavior beyond 15 years, with the greatest impact occurring between 3-9 years following defoliation (Fleming et al 2002a, James et al 2017). For every co-occurrence between a wildfire and insect polygon, we generated a polygon of the intersection (referred to hereafter as co-occurence polygon). Using the resulting co-occurrence polygon and the orgginal fire polygon, we calculated the percentage of the fire polygon that was defoliated in each year by dividing the total are of the fire polygon by the co-occurrence polygon area multiplied by 100. Out of all identified co-occurrence years if the percent of maximum overlap was less than 5% we removed that co-occurrence from our dataset due to the coarseness of defoliation polygons inherent to aerial sketch maps. Additionally, we found that there are only 11 fires below 90% overlap between wildfire-insect co-occurrence. We decided to remove all fires where max overlap was below 90%, for a final sample size of 256 defoliated fires @tbl-overlap. In addition to percent overlap, we also quantified time since defoliation and cumulative years defoliation. We quantified the cumulative years a single fire event was defoliated by counting the number of co-occurrence polygons. Time since defoliation was calculated as the difference between the year of the fire event and the last year an intersection co-occurrence was identified. Out of 1,601 total fires that burned between 1986 and 2012, we identified \# total fires that had a history of defoliation.

```{r}
#| tbl-cap: "Distribution of Percent Overlap between Wildfire-Insect co-occurrence"
#| label: tbl-overlap
#| echo: false

# history defol
history_defol = history %>% 
  filter(history == 1)

# Define the bin width
bin_width <- 10

# Create bins and count the number of observations in each bin
bin_counts <- history_defol %>%
  mutate(bins = cut(Max_Overlap_Percent, breaks = seq(0, max(Max_Overlap_Percent) + bin_width, by = bin_width), right = FALSE)) %>%
  count(bins)

bin_counts <- bin_counts %>%
  mutate(bins = str_replace_all(bins, "[\\[\\]\\(\\),]", "")) %>% 
   mutate(bins = case_when(
    nchar(bins) == 3 ~ str_replace(bins, "(\\d)(\\d{2})", "\\1-\\2%"),
    nchar(bins) == 4 ~ str_replace(bins, "(\\d{2})(\\d{2})", "\\1-\\2%"),
    nchar(bins) == 5 ~ str_replace(bins, "(\\d{2})(\\d{3})", "\\1-\\2%"),
    nchar(bins) == 6 ~ "100%",
    TRUE ~ bins
  )) %>% 
  rename("Percent Overlap" = "bins") %>%
  rename("Number of Fires" = "n")

# View the table
knitr::kable(bin_counts,  align = "c") %>%
  kableExtra::kable_styling(position = "center" )
```

### Burn Severity and recovery magnitude data

The normalized burn ratio (NBR) data used to quantify burn severity and recovery magnitude were derived from the LandTrendr spectral-temporal segmentation algorithm, as detailed by Kennedy et al. (2010). Briefly, LandTrendr (Landsat-based Detection of Trends in Disturbance and Recovery) is designed to reduce noise commonly found in pixel-level analysis by producing a spectral trajectory from Landsat image pixels (Kennedy et al 2010). LandTrendr takes a time series of a spectral index, most commonly NBR or NDVI, and identifies breakpoints between consecutive observations in an otherwise stable time series. Using these breakpoints, LandTrendr creates a new time series where each annual observation is interpolated onto a line of best fit through the observation. This resulting time series focuses on significant, long-term changes in a pixel. Compared to unaltered surface reflectance data, fitted LandTrendr data reduces pixel-level variability caused by climate, atmosphere, phenology, and sun angle. Additionally, the time series produced by LandTrendr allows easy extraction of the magnitude and duration of changes in the spectral index. Fitted LandTrendr data are often used to examine the effects of wildfires on vegetation change (i.e., burn severity) and recovery (Bright et al 2019).

We extracted the fitted NBR data using the Google Earth Engine implementation of LandTrendr (Kennedy et al 2018). For each matched pair (defoliated/non-defoliated portion of the fire event), we assembled a cloud-free Landsat image collection from TM, ELM+ and OLI sensors for all available images between April 31st and October 31st of each year between the year before the fires up to 10 years after the fire year, resulting in a collection of spanning 12 years. Composite images were calculated using a medoid approach for each year in the collection. Medoid compositing selects the most representative pixel in a series that is closest to the median of all pixel values. The result was a single, cloud-free image for each year in the series for each fire. We calculated the NBR from the medoid images and input the time series into the LandTrendr algorithm, resulting in a smoothed NBR times series for each pixel, free of noise.

Using the NBR time series, we calculated percent recovery magnitude and the relativized burn ration (RBR) for each pixel in the series. Recovery magnitude, which is the percent recovery of NBR 10 years after the fire, is calculated by dividing the NBR of the final year in the time series by the difference between the NBR for the year before the fire and the NBR for the year of the fire, multiplied by 100 (Fig S1). The relativized burn ratio (RBR) is a Landsat-based metric that captures changes in forest cover following a fire relative to pre-fire vegetation. RBR is more robust than other Landsat-based measures (e.g., RdNBR) because it is more sensitive to pre-fire values when vegetation cover is low (Parks et al 2014b). RBR is calculated by dividing the dNBR by the pre-fire NBR value (see Supplementary Materials for the equation). In this calculation we also included an offset..

### Fire weather data

To quantify the effect of fire weather on burn severity we used fire weather indices from the Canadian Forest Fire Weather Index (FWI) System (Van Wagner 1987). The FWI system is part of the foundation of Canada's wildfire risk assessment and used operationally by forest managers to effectively predict and evaluate wildfire danger both in Canada and globally. The FWI system is a weather-based system that outputs six indices that are numeric ratings which represent daily fuel moisture and fire behaviour potential. Fine fuel moisture code (FFMC) captures the moisture content of litter fuels. Duff moisture code (DMC) captures the moisture content of loosely compacted organic layers. Drought code (DC) captures the average moisture content of deep organic layers. Initial spread Index (ISI) represents the expected rate of fire spread. Build-up index (BUI) represents the total amount of fuel available to burn. Fire weather index (FWI), which combines ISI and BUI, provides a measure of potential fire intensity. These FWI metrics have been used previously to successfully model wildfire severity in the boreal forest (Whitman et al 2018, San‐Miguel et al 2020, Talucci et al 2022).

Daily fire weather is a strong top-down drive of burn severity (Whitman et al 2018). Because the FWI system represents daily fuel moisture and fire potential, and our measure of burn severity is a single value taken at the end of the fire duration, day-to-day variation over the course of the fire may influence burn severity. To control for this variation in daily fire weather, we calculated the 90th percentile of all indices over the known duration of the fire. This method allows us to capture only extreme FWI events, which have the most influence on wildfire burn severity (Whitman et al 2018). Daily FWI values were interpolated using thin-plate splines to the centroid of each fire perimeter from weather stations across our study region from the day of the year that the fire started burning to the reported fire out date. Because weather station data was only available from 1990 onwards, we focused on fires that burned between 1990.

### Climate data

To quantify the effect of climate on vegetation growth during the 10-year period of post-fire recovery, we calculated mean temperature and precipitation for the growing season for the entire 10-year post-fire recovery period. For each fire, we determined the start and end of the growing season using growing degree days. Growing degree days (GDD) are a common approach to determine growing season length in the boreal shield (CITE). Start of the growing season was determined as 5 consecutive days where GDD \< 5°C after April 31. Likewise, end of the growing season was determined as 5 consecutive days where GDD \>5°C after August 31.

To capture the effects of post-fire climate on recovery magnitude, we calculated mean temperature (°C) and total precipitation (mm) for each matched pair over a 10-year period following the fire. Temperature and precipitation data were extracted from ERA5-Land Daily Aggregated -ECMWF Climate Reanalysis (Muñoz Sabater 2019) in Google Earth Engine. ERA5-Land Daily Aggregated is a reanalysis product that combines model and observation data to produce daily gridded climate data at 9-km spatial resolution from 1950 onwards. We extracted temperature at 2 meters and the total precipitation at the centroid of each fire perimeter from post-fire imagery. We filtered post fire imagery for all dates between April 30th and August 31st of each year. Temperature data were converted from Kelvin to Celsius, and total precipitation was converted from meters to millimeters. These data were used to assess the effects of temperature and precipitation on post-fire regeneration and forest growth.

### Forest Composition

To understand how forest composition affects burn severity and recovery, we analyzed the percentage of each fire-affected area classified as coniferous, broadleaf or mixedwood. We used high-resolution annual forest land cover maps of Canada's forested ecosystems (Hermosilla et al 2022) available in Google Earth Engine. These maps, derived from Landsat time series at a 30-m spatial resolution, represent annual forest land cover. For each year, the maps were created using a best-available-pixel composite image for August 1st and 30th. We calculated the percentage of coniferous, broadleaf or mixedwood areas within the perimeter for each fire-affected area for the year before the fire occurred. We avoided using data from the fire year itself to prevent wildfire events from skewing the estimation of forest composition.

### Statistical matching

Following processing steps outlined above, we identified 807 fires that that burned between 1990 and 2012 prior to matching, consisting of 551 fires without a history of defoliation, and 256 fires with defoliation history (@tbl-ss-nine, @fig-study-area-2 A)). For the purpose of this study, we consider treatment units as fires with a history of defoliation, and control units as those fires without a history of defoliation. In this observational study where assigning randomized treatments was not possible, matching allowed us to reduce bias by creating a sample where confounding factors are balanced between treatment and control units, mimicking a randomized controlled trial matching allows researchers to attribute differences in outcomes more confidently to the treatment rather that confounding variables.

```{r}
#| tbl-cap: "Sample size of defoliated and non-defoliated fires with a maximum overlap greater than 90%"
#| label: tbl-ss-nine
#| message: false
#| echo: false
#| warning: false


ss2 <- history_gt90 %>% 
  group_by(history) %>% 
  summarise("Number of Fires" = n()) %>% 
  mutate(history = case_when(history ==1 ~ "Defoliated",
                           history ==0 ~"Non-Defoliated"))

# View the table
knitr::kable(ss2,  align = "c") %>%
  kableExtra::kable_styling(position = "center" )

```

We used the MatchIt package in R (Ho et al. 2011) to match the treatment fires (defoliated) with control fires (non-defoliated) with the most similar covariate values. Initially, we conducted propensity score martching (PSM) on the entire dataset. The covariates we matched on in the model were weather, topography, spatial and environmental covariates **(TABLE)**. We estimated propensity scores using a generalized linear model with a probit link function. We used nearest neighbor matching with a caliper of 0.10 to ensure that matched pairs had similar propensity scores. Our target estimate was the average treatment effect in the treated (defoliated) fires (ATT). We estimated propensity scores using a generalized linear model with a probit link function. We used nearest neighbor matching with a caliper of 0.10 to ensure that matched pairs had similar propensity scores. Our target estimate was the average treatment effect in the treated (defoliated) fires (ATT). We estimated the treatment effect using g-computation with a cluster-robust standard error to account for pair membership within `marginaleffects` package in `R`. We assessed covariate balance before and after matching using the love plots of the standardized mean difference (SMD) @fig-asmd, and density plots of all covariates @fig-density-cov using the cobalt package (Greifer, 2023). SMD represents the mean difference between treatment and control units and we considered a threshold of \< 0.25 as an indication of acceptable covariate balance (Stuart et al., 2013). Our final sample sizes after matching were 165 treated and control units respectively @fig-study-area-2 B).

```{r, echo=FALSE}
#| fig-cap: Comparison of covariate balance using covariate means for treatment and control units before matching (orange) and after matching (red) to assess whether matching has improved balance. Mean values < 0.25 are considered acceptable covariate balance, dotted line represents 0.1. 
#| label: fig-asmd
#| echo: false

v <- data.frame(old = c("host_pct", "isi_90", "dc_90", 
                        "dmc_90", "ffmc_90", "bui_90", "fwi_90"),
                new = c("Host Species Percentage", "Intial Spread Index", "Drought Code", 
                        "Duff Moisture Code", "Fine Fuel Moisture Code", "Build Up Index", "Fire Weather Index"))

cobalt::love.plot(m.out2, stats = c("mean.diffs"), 
          threshold = c(m = .1), 
          binary = "std",
          abs = TRUE,
          var.order = "unadjusted",
          var.names = v,
          limits = c(0, 1),
          grid = FALSE,
          wrap = 20,
          sample.names = c("Unmatched", "Matched"),
          position = "top",
          shapes = c("circle", "triangle"),
          colors = c("#FF8C00A0", "#8B0000A0"))
```

```{r, echo = FALSE, warning=FALSE, message=FALSE}

#| echo = false
#| warning = false
#| message = false
#| label: covariate balance density plot code

host_plot <- cobalt::bal.plot(m.out2, 
                              var.name = "host_pct", 
                              which = "both",
                              colors = c("#FF8C00A0", "#8B0000A0"),
                              sample.names = c("Unmatched", "Matched")) +scale_fill_manual(
  values = c("0" = "#FF8C00A0", "1" = "#8B0000A0"),
  labels = c("0" = "Non-Defoliated", "1" = "Defoliated"))+xlab("Host Species Percentage") + ggtitle(NULL) +theme_bw() + theme(plot.margin = unit(c(1, 1, 1, 1), "cm"))

isi_plot <- cobalt::bal.plot(m.out2, 
                             var.name = "isi_90", 
                             which = "both", 
                              colors = c("#FF8C00A0", "#8B0000A0"),
                             sample.names = c("Unmatched", "Matched"))+ scale_fill_manual(
  values = c("0" = "#FF8C00A0", "1" = "#8B0000A0"),
  labels = c("0" = "Non-Defoliated", "1" = "Defoliated"))+xlab("Initial Spread Index") + ggtitle(NULL) +theme_bw()+ theme(plot.margin = unit(c(1, 1, 1, 1), "cm"))

dc_plot <- cobalt::bal.plot(m.out2, 
                            var.name = "dc_90", 
                            which = "both", 
                              colors = c("#FF8C00A0", "#8B0000A0"),
                            sample.names = c("Unmatched", "Matched"))+ scale_fill_manual(
  values = c("0" = "#FF8C00A0", "1" = "#8B0000A0"),
  labels = c("0" = "Non-Defoliated", "1" = "Defoliated"))+xlab("Drought Code") + ggtitle(NULL) +theme_bw()+ theme(plot.margin = unit(c(1, 1, 1, 1), "cm"))

dmc_plot <- cobalt::bal.plot(m.out2, 
                             var.name = "dmc_90", 
                             which = "both", 
                              colors = c("#FF8C00A0", "#8B0000A0"),
                             sample.names = c("Unmatched", "Matched"))+ scale_fill_manual(
  values = c("0" = "#FF8C00A0", "1" = "#8B0000A0"),
  labels = c("0" = "Non-Defoliated", "1" = "Defoliated"))+xlab("Duff Moisture Code") + ggtitle(NULL) +theme_bw()+ theme(plot.margin = unit(c(1, 1, 1, 1), "cm"))

ffmc_plot <- cobalt::bal.plot(m.out2, 
                              var.name = "ffmc_90", 
                              which = "both", 
                              colors = c("#FF8C00A0", "#8B0000A0"),
                              sample.names = c("Unmatched", "Matched"))+ scale_fill_manual(
  values = c("0" = "#FF8C00A0", "1" = "#8B0000A0"),
  labels = c("0" = "Non-Defoliated", "1" = "Defoliated"))+xlab("Fine Fuel Moisture Code") + ggtitle(NULL) +theme_bw()+ theme(plot.margin = unit(c(1, 1, 1, 1), "cm"))

bui_plot <- cobalt::bal.plot(m.out2, 
                             var.name = "bui_90", 
                             which = "both", 
                              colors = c("#FF8C00A0", "#8B0000A0"),
                             sample.names = c("Unmatched", "Matched"))+ scale_fill_manual(
  values = c("0" = "#FF8C00A0", "1" = "#8B0000A0"),
  labels = c("0" = "Non-Defoliated", "1" = "Defoliated"))+xlab("Build Up Index") + ggtitle(NULL) +theme_bw()+ theme(plot.margin = unit(c(1, 1, 1, 1), "cm"))

fwi_plot <- cobalt::bal.plot(m.out2, 
                            var.name = "fwi_90", 
                            which = "both", 
                              colors = c("#FF8C00A0", "#8B0000A0"),
                            sample.names = c("Unmatched", "Matched"))+ scale_fill_manual(
  values = c("0" = "#FF8C00A0", "1" = "#8B0000A0"),
  labels = c("0" = "Non-Defoliated", "1" = "Defoliated"))+xlab("Fire Weather Index") + ggtitle(NULL) +theme_bw()+ theme(plot.margin = unit(c(1, 1, 1, 1), "cm"))



```

```{r, echo= FALSE, message = FALSE, warning = FALSE, fig.width=8, fig.height=20}
#| fig-cap: Density of covariates across defoliated fire units (orange curves) and a sample of units non-defoliated fire units (red curves).
#| label: fig-density-cov
#| warning: false
#| message: false
#| echo: false


library(cowplot)

# Arrange the plots in a 2-column layout
plot_grid(host_plot, isi_plot, dc_plot, dmc_plot, ffmc_plot, bui_plot,fwi_plot, ncol = 1, align = 'v', rel_heights = c(1, 1, 1, 1, 1, 1))

```

#### Subgroup analysis

We examined whether the average defoliation effect differs according to various levels of time since defoliation. Prior to matching we subset the defoliated fires into three categories based on the time since defoliation. The categories were defined according to the "window of opportunity" outline by Fleming et al. (2002), who found that wildfire frequency and behaviour was disproportionately higher 3-9 years following defoliation. We subset defoliated fires into the following 3 categories: 0-2 years after defoliation, 3-9 years and greater than 10 years @tbl-ss-subgroup. We compared multiple matching matching methods for each subgroup. The model with the best fit was chosen as the model with the best covariate balance evaluated using SMD \<0.25 for each covariate (Stuart et al. 2013). We evaluated matching on propensity score, Mahalanobis distance, or matching on Mahalanobis distance while restricting propensity score between pairs. A combination of the two approached often preforms better then each individually (Rosenbaum and Rubin 1989). Matching occurred without replacement. Propensity scores were estimated using both nearest neighbour and optimal matching with either logit or probit link functions and we evaluated three separate calipers (Appendix A). The best model for each subgroup is presented in @tbl-sugroup-best-model. Using the best model for each subgroup, we calculated the average treatment effect (ATT) of defoliation history.

```{r warning=FALSE, message=FALSE, echo=FALSE}
#| echo: false
#| warning: false
#| message: false
#| label: params

methods <- c("nearest", "optimal")
distances <- c("glm", "mahalanobis")
links <- c("logit", "probit")
m_orders <- c("random")
calipers <- c(0.1, 0.2, 0.3)
replace_list <- c(FALSE)
use_mahvars_list <- c(FALSE, TRUE)

```

```{r warning=FALSE, message=FALSE, echo=FALSE}
#| tbl-cap: "Sample size of defoliated and non-defoliated fires with a maximum overlap greater than 90%"
#| label: tbl-ss-subgroup
#| message: false
#| echo: false
#| warning: false


ss_sg1 <- hist_gt90_1 %>% 
  group_by(history) %>% 
  summarise("Number of Fires" = n()) %>% 
  mutate(history = case_when(history ==1 ~ "Defoliated",
                           history ==0 ~"Non-Defoliated")) %>% 
  mutate(subgroup = "0-2 years after defoliation") %>% filter(history != "Non-Defoliated") %>% 
  select(-c(history))

ss_sg2 <- hist_gt90_2 %>% 
  group_by(history) %>% 
  summarise("Number of Fires" = n()) %>% 
  mutate(history = case_when(history ==1 ~ "Defoliated",
                           history ==0 ~"Non-Defoliated"))%>% 
  mutate(subgroup = "3-9 years after defoliation")%>% filter(history != "Non-Defoliated") %>% 
  select(-c(history))

ss_sg3 <- hist_gt90_3 %>% 
  group_by(history) %>% 
  summarise("Number of Fires" = n()) %>% 
  mutate(history = case_when(history ==1 ~ "Defoliated",
                           history ==0 ~"Non-Defoliated"))%>% 
  mutate(subgroup = "10+ years after defoliation") %>% filter(history != "Non-Defoliated") %>% 
  select(-c(history))

ss_sg_nd <-  hist_gt90_3 %>% 
  group_by(history) %>% 
  summarise("Number of Fires" = n()) %>% 
  mutate(history = case_when(history ==1 ~ "Defoliated",
                           history ==0 ~"Non-Defoliated"))%>% 
  mutate(subgroup = "Non-Defoliated") %>% filter(history != "Defoliated") %>% 
  select(-c(history))

ss_sg <- rbind(ss_sg1, ss_sg2, ss_sg3, ss_sg_nd)

# View the table
knitr::kable(ss_sg,  align = "c") %>%
  kableExtra::kable_styling(position = "center" )

```

```{r warning=FALSE, message=FALSE, echo=FALSE}
#| warning: false
#| message: false
#| echo: false
#| label: Average treatment effect-full mod severity

fit <- lm(rbr_w_offset  ~ history *(host_pct+ isi_90 + dc_90+ dmc_90 + ffmc_90 + bui_90 + fwi_90),  data = m.data,weights = weights)

fit_att <- as.data.frame(marginaleffects::avg_comparisons(fit,
                variables = "history",
                vcov = ~subclass,
                newdata = subset(history == 1))) %>% 
  mutate(Fires= "all")


```

```{r warning=FALSE, message=FALSE, echo=FALSE}
#| warning: false
#| message: false
#| echo: false
#| label: Average treatment effect-full mod-recovery

m.data.rec_test  <- m.data.rec %>% 
  mutate(history = case_when(history == 1 ~ "Defoliated",
                             history == 0 ~ "Non-Defoliated"))

fit_rec_baseline <- lm(recovery  ~ history *(host_pct+rbr_w_offset + mean_temperature + sum_precipitation_mm),  data = m.data.rec_test,weights = weights)

fit_att_rec <- as.data.frame(marginaleffects::avg_comparisons(fit_rec_baseline,
                variables = "history",
                vcov = ~subclass,
                newdata = subset(history == "Defoliated"))) %>% 
  mutate(Fires= "all")

p <- marginaleffects::plot_predictions(fit_rec_baseline, condition = c("history"), draw = FALSE) 

p <- p %>% 
  mutate(Fires = "All")

plot1 <- ggplot(p, aes(x = history, y = estimate, color = history)) +
  geom_point(size = 4) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2) +
  labs(y = "Recovery Magnitude (%)", x = "Defoliation History", color = "History") +
  scale_x_discrete(labels = c("Non-Defoliated", "Defoliated")) +
  scale_color_manual(values = c("Defoliated" = "#FF8C00A0", "Non-Defoliated" = "#8B0000A0")) +
  theme_bw()+
  theme(legend.position = "none")
```

```{r warning=FALSE, message=FALSE, echo=FALSE}
#| warning: false
#| message: false
#| echo: false
#| label: recovery-subgroup-matched-data-tsd1

best_model_info_recovery <- find_best_model(hist_gt90_1, "recovery", methods, distances, links, m_orders, calipers, replace_list, use_mahvars_list)
best_model_1_recovery <- best_model_info_recovery$best_model
all_results_recovery <- best_model_info_recovery$results

m.data.rec.w1 <- match_data(best_model_1_recovery)

m.data.rec.w1  <- m.data.rec.w1 %>% 
  mutate(history = case_when(history == 1 ~ "Defoliated",
                             history == 0 ~ "Non-Defoliated"))

fit.rec.w1 <- lm(recovery  ~ history *(host_pct+rbr_w_offset + mean_temperature + sum_precipitation_mm),  data = m.data.rec.w1,weights = weights)

att.rec.w1 <- as.data.frame(marginaleffects::avg_comparisons(fit.rec.w1,
                variables = "history",
                vcov = ~subclass,
                newdata = subset(history == "Defoliated"))) %>% 
  mutate(Fires= "0-2 years defoliated")

p1 <- marginaleffects::plot_predictions(fit.rec.w1, condition = c("history"), draw = FALSE) 

p1 <- p1 %>% 
  mutate(Fires= "0-2 years after defoliation")

plot2 <- ggplot(p1, aes(x = history, y = estimate, color = history)) +
  geom_point(size = 4) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2) +
  labs(y = "Recovery Magnitude (%)", x = "Defoliation History", color = "History") +
  scale_x_discrete(labels = c("Non-Defoliated", "Defoliated")) +
  scale_color_manual(values = c("Defoliated" = "#FF8C00A0", "Non-Defoliated" = "#8B0000A0")) +
  theme_bw()+
  theme(legend.position = "none")
```

```{r warning=FALSE, message=FALSE, echo=FALSE}
#| warning: false
#| message: false
#| echo: false
#| label: recovery-subgroup-matched-data-tsd2

best_model_info_recovery <- find_best_model(hist_gt90_2, "recovery", methods, distances, links, m_orders, calipers, replace_list, use_mahvars_list)
best_model_2_recovery <- best_model_info_recovery$best_model
all_results_recovery <- best_model_info_recovery$results

m.data.rec.w2 <- match_data(best_model_2_recovery)

m.data.rec.w2  <- m.data.rec.w2 %>% 
  mutate(history = case_when(history == 1 ~ "Defoliated",
                             history == 0 ~ "Non-Defoliated"))

fit.rec.w2 <- lm(recovery  ~ history *(host_pct+rbr_w_offset + mean_temperature + sum_precipitation_mm),  data = m.data.rec.w2,weights = weights)

att.rec.w2 <- as.data.frame(marginaleffects::avg_comparisons(fit.rec.w2,
                variables = "history",
                vcov = ~subclass,
                newdata = subset(history == "Defoliated"))) %>% 
  mutate(Fires= "3-9 years defoliated")

p2 <- marginaleffects::plot_predictions(fit.rec.w2, condition = c("history"), draw = FALSE) 

p2 <- p2 %>% 
  mutate(Fires= "3-9 years after defoliation")

plot3 <- ggplot(p2, aes(x = history, y = estimate, color = history)) +
  geom_point(size = 4) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2) +
  labs(y = "Recovery Magnitude (%)", x = "Defoliation History", color = "History") +
  scale_x_discrete(labels = c("Non-Defoliated", "Defoliated")) +
  scale_color_manual(values = c("Defoliated" = "#FF8C00A0", "Non-Defoliated" = "#8B0000A0")) +
  theme_bw()+
  theme(legend.position = "none")
```

```{r warning=FALSE, message=FALSE, echo=FALSE}
#| warning: false
#| message: false
#| echo: false
#| label: recovery-subgroup-matched-data-tsd3

best_model_info_3_recovery <- find_best_model(hist_gt90_3, "recovery", methods, distances, links, m_orders, calipers, replace_list, use_mahvars_list)
best_model_3_recovery <- best_model_info_3_recovery$best_model
all_results_recovery <- best_model_info_3_recovery$results

m.data.rec.w3 <- match_data(best_model_3_recovery)

m.data.rec.w3  <- m.data.rec.w3 %>% 
  mutate(history = case_when(history == 1 ~ "Defoliated",
                             history == 0 ~ "Non-Defoliated"))

fit.rec.w3 <- lm(recovery  ~ history *(host_pct+rbr_w_offset + mean_temperature + sum_precipitation_mm),  data = m.data.rec.w3,weights = weights)

att.rec.w3 <- as.data.frame(marginaleffects::avg_comparisons(fit.rec.w3,
                variables = "history",
                vcov = ~subclass,
                newdata = subset(history == "Defoliated"))) %>% 
  mutate(Fires= "10+ years defoliated")

p3 <- marginaleffects::plot_predictions(fit.rec.w3, condition = c("history"), draw = FALSE) 

p3 <- p3 %>%  
  mutate(Fires= "10-15 years after defoliation")
  
plot4 <- ggplot(p3, aes(x = history, y = estimate, color = history)) +
  geom_point(size = 4) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2) +
  labs(y = "Recovery Magnitude (%)", x = "Defoliation History", color = "History") +
  scale_x_discrete(labels = c("Non-Defoliated", "Defoliated")) +
  scale_color_manual(values = c("Defoliated" = "#FF8C00A0", "Non-Defoliated" = "#8B0000A0")) +
  theme_bw()+
  theme(legend.position = "none")
```

```{r warning=FALSE, message=FALSE, echo=FALSE}

#| warning: false
#| message: false
#| echo: false
#| label: subgroup-matched-data-tsd1

best_model_info <- find_best_model(hist_gt90_1, "severity",methods, distances, links, m_orders, calipers, replace_list, use_mahvars_list)
best_model_1 <- best_model_info$best_model
all_results <- best_model_info$results

m.data.w1 <- match_data(best_model_1)


m.data.w1 %>% 
  group_by(history) %>% 
  summarise("Number of Fires" = n()) %>% 
  mutate(history = case_when(history ==1 ~ "Defoliated",
                           history ==0 ~"Non-Defoliated"))

```

```{r warning=FALSE, message=FALSE, echo=FALSE}
#| warning: false
#| message: false
#| echo: false
#| label: subgroup-matched-data-tsd2

best_model_info <- find_best_model(hist_gt90_2, "severity",methods, distances, links, m_orders, calipers, replace_list, use_mahvars_list)
best_model_2 <- best_model_info$best_model
all_results <- best_model_info$results

m.data.w2 <- match_data(best_model_2)


m.data.w2 %>% 
  group_by(history) %>% 
  summarise("Number of Fires" = n()) %>% 
  mutate(history = case_when(history ==1 ~ "Defoliated",
                           history ==0 ~"Non-Defoliated"))


```

```{r warning=FALSE, message=FALSE, echo=FALSE}
#| warning: false
#| message: false
#| echo: false
#| label: subgroup-matched-data-tsd3

best_model_info <- find_best_model(hist_gt90_3, "severity", methods, distances, links, m_orders, calipers, replace_list, use_mahvars_list)
best_model_3 <- best_model_info$best_model
all_results <- best_model_info$results



m.data.w3 <- match_data(best_model_3)


m.data.w3 %>% 
  group_by(history) %>% 
  summarise("Number of Fires" = n()) %>% 
  mutate(history = case_when(history ==1 ~ "Defoliated",
                           history ==0 ~"Non-Defoliated"))


```

```{r warning=FALSE, message=FALSE, echo=FALSE}

#| warning: false
#| message: false
#| echo: false
#| label: subgroup-fit1

fit.w1 <- lm(rbr_w_offset  ~ history *(host_pct+ isi_90 + dc_90+ dmc_90 + ffmc_90 + bui_90 + fwi_90),  data = m.data.w1,weights = weights)

fit.w1_att <- as.data.frame(marginaleffects::avg_comparisons(fit.w1,
                variables = "history",
                vcov = ~subclass,
                newdata = subset(history == 1)))%>% 
  mutate(Fires= "0-2 years after defoliation")
```

```{r warning=FALSE, message=FALSE, echo=FALSE}

#| warning: false
#| message: false
#| echo: false
#| label: subgroup-fit2


fit.w2 <- lm(rbr_w_offset  ~ history *(host_pct+ isi_90 + dc_90+ dmc_90 + ffmc_90 + bui_90 + fwi_90),  data = m.data.w2,weights = weights)

fit.w2_att <- as.data.frame(marginaleffects::avg_comparisons(fit.w2,
                variables = "history",
                vcov = ~subclass,
                newdata = subset(history == 1))) %>% 
  mutate(Fires= "3-9 years after defoliation")
```

```{r warning=FALSE, message=FALSE, echo=FALSE}

#| warning: false
#| message: false
#| echo: false
#| label: subgroup-fit3

fit.w3 <- lm(rbr_w_offset  ~ history *(host_pct+ isi_90 + dc_90+ dmc_90 + ffmc_90 + bui_90 + fwi_90),  data = m.data.w3,weights = weights)

fit.w3_att <- as.data.frame(marginaleffects::avg_comparisons(fit.w3,
                variables = "history",
                vcov = ~subclass,
                newdata = subset(history == 1))) %>% 
  mutate(Fires= "10+ years after defoliation")
```

```{r}

#| warning: false
#| message: false
#| echo: false
#| label: fig-subgroup-plot
#| fig-cap: Average treatment effect (ATT) estimates and their lower (2.5%) and upper (97.5%) confidence intervals for the effects of defoliation for entire dataset (all) and across all levels of time since defoliation.

att_comparison <- rbind(fit_att, fit.w1_att, fit.w2_att, fit.w3_att)

# Specify the desired order of the x-axis values
desired_order <- c("all", "0-2 years after defoliation", "3-9 years after defoliation", "10+ years after defoliation")  # Replace with your actual values

# Convert the fires column to a factor with the specified order
att_comparison$Fires <- factor(att_comparison$Fires, levels = desired_order)


ggplot(att_comparison, aes(x = Fires, y = estimate)) +
    geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.5, colour = "#8B0000A0") +
  geom_point(color="#8B0000A0", size = 4) +
  labs(x = "Data Subgroup", y = "Average Treatment Estimate (RBR)") +
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
  
  
  
```

```{r}
#| echo: false
#| label: tbl-att-summary
#| tbl-cap: Average defoliation effect on Burn Severity based on defolation status (window of opportunity)
options(scipen = 999)
att_comparison %>% 
  relocate(Fires, .before = term) %>% 
  rename(Subgroup = Fires) %>%  
  mutate(conf.low = round(conf.low, 2),
         conf.high = round(conf.high, 2)) %>% 
  mutate(`95% CI` = paste(conf.low, conf.high, sep = ", ")) %>% 
  select(c(Subgroup, estimate, std.error, `95% CI`, statistic, p.value)) %>% 
  rename(`p` = `p.value` ) %>% 
  rename("se ± " = "std.error") %>% 
  mutate(p = if_else(`p` < 0.0001, "< 0.0001", as.character(`p`)))%>% 
  mutate(across(where(is.numeric), round, 2)) %>% 
  knitr::kable(.,  align = "l") %>%
  kableExtra::kable_styling(position = "left" )
```

```{r}
#| echo: false
#| label: tbl-sugroup-best-model
#| tbl-cap: Matching parameters for subgroup models chosen based on best covariate balance of all covariates with SMD <0.25.

subgroup_modstruct <- extract_best_model_params(best_model_1, best_model_2, best_model_3)

# View the table
knitr::kable(subgroup_modstruct,  align = "l") %>%
  kableExtra::kable_styling(position = "left" )

```

#### Spatial patterns of severity and recovery in defoliated fires

Based on *a priori* expectations of east-west variations in vegetation type, composition, and climate, we examined the spatial patterns of burn severity and recovery magnitude for fires with a history of defoliation (n = 256). We modeled burn severity as a function of host percentage, cumulative years of defoliation, time since defoliation, and several fire weather indices. Recovery magnitude was modeled as a function of host percentage, cumulative years of defoliation, time since defoliation, burn severity, mean tempeature and total precipitation.In each model time since defoliation was modeled as a factor with 3 levels corresponding to three windows of opportunity. We included an interaction between cumulative years of defoliation and time since defoliation, as we predict areas where defoliated occurred in successive years will have greater burn severity due to increase fuel loads, and lower recovery magnitude due to increased severity. Therefore we would expect the interaction between cumulative years of defoliation and time since defoliation to reveal hotspots with a high degree of burn severity, or low levels of recovery magnitude. We fit a generalized least squares (GLS) model with a Gaussian spatial correlation structure, where correlation decreases with distance. Model fit was assessed by plotting residuals against fitted values (Appendix 1), and indicated a good fit with residuals centered around zero. To assess spatial autocorrelation, a variogram of the residuals was computed (Appendix 1) and plotted the spatial distribution of the model residuals.

```{r warning=FALSE, message=FALSE, echo=FALSE}
#| echo: false
#| warning: false
#| label: gls-severity-full model

library(lme4)
library(MuMIn)
library(lmerTest)
library(nlme)
library(sp)
library(gstat)


# defol dataset
defol_only <- subset(history_gt90, history == 1)

# shift window_opp to 1-3 from 0-2
defol_only <- defol_only %>%
  mutate(window_opp = case_when(window_opp == "0" ~ "1",
                                TRUE ~ window_opp))


# Define the model formula
formula <- rbr_w_offset ~host_pct +  Cumulative_Years_Defol:window_opp + isi_90 + 
                    dc_90 + dmc_90 + ffmc_90 + bui_90+ fwi_90 +  x + y 

# Fit the model using nlme with spatial correlation, where correlation decreases with distance
# gls

model_gls <- gls(formula,
                 correlation = corGaus(form = ~ x + y), 
                 data = defol_only)

# Residuals vs. Fitted Values Plot
residual_plot <- plot(fitted(model_gls), resid(model_gls)) +abline(h = 0, col = "red") # fit is good

#model_glsI <- update(model_gls, weights = varIdent(form = ~ 1 | Time_Since_Defol))


# Display the model summary
summary(model_gls)

# r2
rsquared.gls(model_gls, formula)

# extract residuals
defol_only$residuals_gls <- residuals(model_gls)

colnames(defol_only) <- make.names(colnames(defol_only))

# get coords
coordinates(defol_only) <- ~ x + y

# Compute the variogram
variogram_gls <- variogram(residuals_gls ~ 1, data = defol_only)

# Plot the variogram
var_plot <- plot(variogram_gls, main = "Variogram of Residuals (Gaussian)")

# confirm defol_only as dataframe
df <- as.data.frame(defol_only)



```

```{r}
#| label: fig-spatial-residuals-severity
#| fig-cap: Spatial distribution of model residuals. 
#| echo: false
#| warning: false
#| message: false



# Create a spatial plot of residuals
ggplot() +
  geom_sf(data = ontario, fill = "navajowhite1", color = "black") +
  geom_point(data = df, aes(x = x, y = y, color = residuals_gls)) +
  scale_color_gradient2(low = "#88CCEEA0", mid = "white", high = "#8B0000A0", midpoint = 0) +
  labs(title = NULL, x = "Longitude", y = "Latitude", color = "Residuals") +
  theme_bw()
```

```{r warning=FALSE, message=FALSE, echo=FALSE}
#| echo: false
#| warning: false
#| label: gls-recovery-full model

library(lme4)
library(MuMIn)
library(lmerTest)
library(nlme)
library(sp)
library(gstat)


# defol dataset
defol_only <- subset(history_gt90, history == 1)

# shift window_opp to 1-3 from 0-2
defol_only <- defol_only %>%
  mutate(window_opp = case_when(window_opp == "0" ~ "1",
                                TRUE ~ window_opp))


# Define the model formula
formula <- recovery ~host_pct +  Cumulative_Years_Defol:window_opp + rbr_w_offset +
  mean_temperature + sum_precipitation_mm +  x + y 

# Fit the model using nlme with spatial correlation, where correlation decreases with distance
# gls

model_gls_rec <- gls(formula,
                 correlation = corGaus(form = ~ x + y), 
                 data = defol_only)

# Residuals vs. Fitted Values Plot
residual_plot_rec <- plot(fitted(model_gls_rec), resid(model_gls_rec)) +abline(h = 0, col = "red") # fit is good

#model_glsI <- update(model_gls, weights = varIdent(form = ~ 1 | Time_Since_Defol))


# Display the model summary
summary(model_gls_rec)

# r2
rsquared.gls(model_gls_rec, formula)

# extract residuals
defol_only$residuals_gls_rec <- residuals(model_gls_rec)

colnames(defol_only) <- make.names(colnames(defol_only))

# get coords
coordinates(defol_only) <- ~ x + y

# Compute the variogram
variogram_gls_rec <- variogram(residuals_gls_rec ~ 1, data = defol_only)

# Plot the variogram
var_plot_rec <- plot(variogram_gls_rec, main = "Variogram of Residuals (Gaussian)")

# confirm defol_only as dataframe
df_rec <- as.data.frame(defol_only)


```

```{r}
#| label: fig-spatial-residuals-recovery
#| fig-cap: Spatial distribution of model residuals. 
#| echo: false
#| warning: false
#| message: false



# Create a spatial plot of residuals
ggplot() +
  geom_sf(data = ontario, fill = "navajowhite1", color = "black") +
  geom_point(data = df_rec, aes(x = x, y = y, color = residuals_gls_rec)) +
  scale_color_gradient2(low = "#88CCEEA0", mid = "white", high = "#8B0000A0", midpoint = 0) +
  labs(title = NULL, x = "Longitude", y = "Latitude", color = "Residuals") +
  theme_bw()
```

### Results

*Defoliation effect estimate on burn severity*

We analyzed the impact of defoliation on burn severity by comparing 330 fires (165 defoliated and 165 non-defoliated) that occurred in the boreal shield of Ontario from 1990 to 2012. We found that fires with a history of defoliation had higher burn severity than fires without a history of defoliation. These results indicate that having a history of defoliation has a significant positive effect on the outcome, with an average effect size of 55.49 [@tbl-att-summary]. When comparing the impacts of defoliation according to different levels of time since defoliation following the "window of opportunity" described by Fleming et al. (2002), the overall average effect (55.50) is lower than the subgroup effects, highlighting that the burn severity is more pronounced when considering specific time frames post-defoliation. Additionally, our results indicate that the impact of defoliation on burn severity is not only immediate but also increases over time [@fig-subgroup-plot]. The average effect size grows from 73.21 in the first 2 years to 114.11 after 10 years [@tbl-att-summary].

*Spatial patterns of burn severity*

We assessed the spatial distribution of burn severity of all 256 defoliated fires that burned in the boreal shield of Ontario from 1990 to 2012 using a GLS model with a Gaussian correlation structure which incorporated the effects of defoliation and climate variables. The spatial correlation structure indicates a range parameter estimate of 0.0444, suggesting a relatively short spatial correlation range (Appendix 1) [@fig-spatial-residuals]. This implies that spatial autocorrelation is present but diminishes quickly over distance. The spatial distribution of model residuals [@fig-spatial-residuals], reveals no obvious patterns of burn severity from east-to-west. We found that the significant predictors identified in the model, such as the percentage of host species (host %), Initial Spread Index, and interaction between cumulative years defoliated and time since defoliation (10-15 years) [@tbl-gls-severity], remain influential even after accounting for spatial autocorrelation. Percentage of host species (Host %) was found to have a significant negative effect on burn severity, indicating that higher percentages of host species within a fire are associated with lower burn severity [@tbl-gls-severity]. Initial spread Index showed a significant positive effect on burn severity, suggesting under conditions favouring a higher rate of spread we observed an increased burn severity [@tbl-gls-severity]. Among the defoliation variables, the interaction term cumulative years defoliated and time since defoliation (10-15 years) was significant, and implies that areas defoliated for 10-15 years exhibit higher burn severity compared to other periods. While all other variables did not show a significant impact on burn severity.

```{r}
#| tbl-cap: "Results from Generalized Least Squares (GLS) model with Gaussian correlation structure assessing the effects of defoliation and climate covariates on burn severity, accounting for spatial autocorrelation in residuals."
#| label: tbl-gls-severity
#| echo: false
#| warning: false
gls_pvalues_to_kable(model_gls)
```

*Defoliation effect estimate on recovery magnitude*

We analyzed the impact of defoliation on recovery magnitude by comparing 308 fires (154 defoliated and 154 non-defoliated) that occurred in the boreal shield of Ontario from 1990 to 2012. We found a significant negative impact of defoliation on recovery following a wildfire across all examined time periods. The overall average defoliation effect (ATE) was -24.34 [@tbl-att-summary-recovery]. Across all examined time periods of time since defoliation, we observed a significant negative trend in recovery magnitude [@fig-subgroup-recovery]. In the first 0-2 years post-defoliation, the ATE was -16.14. For the period 3-9 years after defoliation, the ATE was -17.96. Even 10+ years post-defoliation, the negative effect on recovery persisted, with an ATE of -19.69. The consistently negative effect indicates that defoliation hinders recovery regardless of defoliation occurring over short and long-term periods .These results underscore the long-term detrimental effects of defoliation on recovery following a wildfire.

```{r}
#| warning: false
#| message: false
#| echo: false
#| label: fig-subgroup-recovery

all_rec = rbind(p, p1, p2, p3)

# Specify the desired order of the x-axis values
desired_order <- c("All", "0-2 years after defoliation", "3-9 years after defoliation", "10-15 years after defoliation")  # Replace with your actual values

# Convert the fires column to a factor with the specified order
all_rec$Fires <- factor(all_rec$Fires, levels = desired_order)

ggplot(all_rec, aes(x = Fires, y = estimate, fill = history)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.7), width = 0.7, color = "black") +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2, position = position_dodge(width = 0.7)) +
  labs(y = "Recovery Magnitude (%)", x = "Data Subgroup", fill = "Defoliation History") +
  scale_fill_manual(values = c("Defoliated" = "#FF8C00A0", "Non-Defoliated" = "#8B0000A0")) +
  scale_y_continuous(expand = c(0, 0), limits = c(70, 105), oob = scales::squish) +
  theme_bw() +
  theme(
    legend.position = "right",
    panel.border = element_rect(color = "black", size = 0.8)  # Adjust the size to change border thickness
  )

```

```{r warning=FALSE, message=FALSE, echo=FALSE}
#| warning: false
#| message: false
#| echo: false
#| label: fig-subgroup-plot-recovery
#| fig-cap: Average treatment effect (ATT) estimates and their lower (2.5%) and upper (97.5%) confidence intervals for the effects of defoliation for entire dataset (all) and across all levels of time since defoliation.

att_comparison_rec <- rbind(att.rec.w1, att.rec.w2, att.rec.w3, fit_att_rec)

# Specify the desired order of the x-axis values
desired_order <- c("all", "0-2 years after defoliation", "3-9 years after defoliation", "10+ years after defoliation")  # Replace with your actual values

# Convert the fires column to a factor with the specified order
att_comparison_rec$Fires <- factor(att_comparison$Fires, levels = desired_order)


ggplot(att_comparison_rec, aes(x = Fires, y = estimate)) +
    geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.5, colour = "#8B0000A0") +
  geom_point(color="#8B0000A0", size = 4) +
  labs(x = "Data Subgroup", y = "Percent change in Recovery Magnitude") +
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
  
# average effect of defoliation
  
```

```{r warning=FALSE, message=FALSE, echo=FALSE}
#| echo: false
#| label: tbl-att-summary-recovery
#| tbl-cap: Average defoliation effect on Burn Severity based on defolation status (window of opportunity)
options(scipen = 999)
att_comparison_rec %>% 
  relocate(Fires, .before = term) %>% 
  rename(Subgroup = Fires) %>%  
  mutate(conf.low = round(conf.low, 2),
         conf.high = round(conf.high, 2)) %>% 
  mutate(`95% CI` = paste(conf.low, conf.high, sep = ", ")) %>% 
  select(c(Subgroup, estimate, std.error, `95% CI`, statistic, p.value)) %>% 
  rename(`p` = `p.value` ) %>% 
  rename("se ± " = "std.error") %>% 
  mutate(across(where(is.numeric), round, 3)) %>% 
  mutate(p = if_else(`p` < 0.0001, "< 0.0001", as.character(`p`)))%>% 
  mutate(across(where(is.numeric), round, 2)) %>% 
  knitr::kable(.,  align = "l") %>%
  kableExtra::kable_styling(position = "left" )
```

```{r}
#| echo: false
#| label: tbl-sugroup-best-model-recovery
#| tbl-cap: Matching parameters for subgroup models chosen based on best covariate balance of all covariates with SMD <0.25.

subgroup_modstruct_rec <- extract_best_model_params(best_model_1_recovery, best_model_2_recovery, best_model_3_recovery)

# View the table
knitr::kable(subgroup_modstruct_rec,  align = "l") %>%
  kableExtra::kable_styling(position = "left" )

```

*Spatial patterns of recovery magnitude*

We assessed the spatial distribution of recovery magnitude of all 256 defoliated fires that burned in the boreal shield of Ontario from 1990 to 2012 using a GLS model with a Gaussian correlation structure which incorporated the effects of defoliation, burn severity and post-fire recovery climate. The spatial distribution of model residuals revealed no obvious patterns [@fig-spatial-residuals-recovery], and the spatial correlation structure indicated a range parameter estimate of 0.0011, suggesting a very short spatial correlation range. Significant predictors identified in the model included the percentage of host species and cumulative years of defoliation in the first and second windows. The percentage of host species within a fire had a significant negative effect on recovery magnitude, indicating that higher percentages of host species are associated with lower recovery magnitude. Cumulative years of defoliation in the first window and in the second window showed significant positive effects on recovery magnitude, suggesting that defoliation over these periods is associated with higher recovery magnitude. Other variables, such as mean temperature, sum precipitation, and burn severity, did not show significant effects. These results highlight the significant influence of host plant percentage and cumulative years of defoliation on recovery magnitude, while other factors did not show significant impacts.

### Discussion

Our findings highlight the important role of spatial legacies of spruce budworm defoliation on exacerbating the impacts of wildfire on post-fire biomass and soil change (burn severity) and recovery capacity and reveal variability in the impactfulness of spatial legacies based on the amount, duration of, and time since defoliation. Our resutls

Goals:

-   Present principles, relationships and generalizations shown by the results

-   Point out exceptions or lack of correlations. Define why you think this is so.

-   Show how your results agree or disagree with previously published works

-   Discuss the theoretical implications of your work as well as practical applications

-   State your conclusions clearly. Summarize your evidence for each conclusion.

-   Discuss the significance of the results

checklist

-   Evidence does not explain itself; the results must be presented and then explained.

-   Typical stages in the discussion: summarizing the results, discussing whether results are expected or unexpected, comparing these results to previous work, interpreting and explaining the results (often by comparison to a theory or model), and hypothesizing about their generality.

-   Discuss any problems or shortcomings encountered during the course of the work.

-   Discuss possible alternate explanations for the results.

-   Avoid: presenting results that are never discussed; presenting discussion that does not relate to any of the results; presenting results and discussion in chronological order rather than logical order; ignoring results that do not support the conclusions; drawing conclusions from results without logical arguments to back them up. 

### Conclusion

checklist

-   Provide a very brief summary of the Results and Discussion.

-   Emphasize the implications of the findings, explaining how the work is significant and providing the key message(s) the author wishes to convey.

-   Provide the most general claims that can be supported by the evidence.

-   Provide a future perspective on the work.

-   Avoid: repeating the abstract; repeating background information from the Introduction; introducing new evidence or new arguments not found in the Results and Discussion; repeating the arguments made in the Results and Discussion; failing to address all of the research questions set out in the Introduction. 

These findings highlight the critical roles of host presence, initial spread conditions, and long-term defoliation in influencing burn severity. The model underscores the importance of considering both biotic and abiotic factors, as well as their interactions, in understanding and predicting burn severity in forested landscapes.

Overall, the model effectively captures the spatial distribution of burn severity, highlighting the importance of considering spatial autocorrelation in ecological studies.

### Host species percentage

Now lets look at the distribution of host species percentage with this subset of data

```{r}
#| tbl-cap: "Distribution of Host Species Percentage between Wildfire-Insect co-occurrence"
#| label: tbl-host-species-percentage
#| tbl-colwidths: [60,40]
#| echo: false

# history defol
history_defol = history_gt90 %>% 
  filter(history == 1)
# history non_defol 
history_non = history_gt90 %>% 
  filter(history == 0)

# Define the bin width
bin_width <- 10

# defoliation
# Create bins and count the number of observations in each bin
bin_counts_defol <- history_defol %>%
  mutate(bins = cut(host_pct, breaks = seq(0, max(host_pct) + bin_width, by = bin_width), right = FALSE)) %>%
  count(bins)

bin_counts_defol <- bin_counts_defol %>%
  mutate(bins = str_replace_all(bins, "[\\[\\]\\(\\),]", "")) %>% 
   mutate(bins = case_when(
    nchar(bins) == 3 ~ str_replace(bins, "(\\d)(\\d{2})", "\\1-\\2%"),
    nchar(bins) == 4 ~ str_replace(bins, "(\\d{2})(\\d{2})", "\\1-\\2%"),
    nchar(bins) == 5 ~ str_replace(bins, "(\\d{2})(\\d{3})", "\\1-\\2%"),
    nchar(bins) == 6 ~ "100%",
    TRUE ~ bins
  )) %>% 
  rename("Host Percent" = "bins") %>%
  rename("Defoliated Fires" = "n")


# non-defoliated
# Create bins and count the number of observations in each bin
bin_counts_non <- history_non %>%
  mutate(bins = cut(host_pct, breaks = seq(0, max(host_pct) + bin_width, by = bin_width), right = FALSE)) %>%
  count(bins)

bin_counts_non <- bin_counts_non %>%
  mutate(bins = str_replace_all(bins, "[\\[\\]\\(\\),]", "")) %>% 
   mutate(bins = case_when(
    nchar(bins) == 3 ~ str_replace(bins, "(\\d)(\\d{2})", "\\1-\\2%"),
    nchar(bins) == 4 ~ str_replace(bins, "(\\d{2})(\\d{2})", "\\1-\\2%"),
    nchar(bins) == 5 ~ str_replace(bins, "(\\d{2})(\\d{3})", "\\1-\\2%"),
    nchar(bins) == 6 ~ "100%",
    TRUE ~ bins
  )) %>% 
  rename("Host Percent" = "bins") %>%
  rename("Non-Defoliated Fires" = "n")

# merge the two together
host_spp_pct = bin_counts_defol %>% 
  left_join(bin_counts_non, by= c("Host Percent"))

# View the table
knitr::kable(host_spp_pct,  align = "c") %>%
  kableExtra::kable_styling(position = "center" )
```

For non-defoliated fires, there are only single digit non-defoliated for host percent before 50. In the following analysis we will look at the distribution of fires for each bin
